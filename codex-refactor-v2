# Codex Refactor Plan v2

## 1. Chuẩn hóa Unicode + TypeScript
- [ ] Chuyển toàn bộ source sang UTF-8 chuẩn và sửa các chuỗi bị mojibake trong `src/app/page.tsx:1-120`, `src/components/layout/SharedFooter.tsx:13-36`, `scripts/seed-posts.mjs:20-70`...
- [ ] Loại bỏ `@ts-nocheck` và bật lại strict type checking/Lint (ví dụ `src/lib/settings-actions.ts:1`, `src/app/tim-kiem/page.tsx:1`, `src/lib/contact-actions.ts:1`).
- [ ] Thêm cấu hình ESLint/Prettier chạy trong CI, cập nhật README hướng dẫn.

## 2. Layout & điều hướng thống nhất
- [ ] Dùng `src/components/layout/Header.tsx` và `SharedFooter` trực tiếp trong `src/app/layout.tsx` thay vì copy markup ở từng trang (`src/app/page.tsx:18-80`, `src/app/tim-kiem/page.tsx:24-63`, `src/app/lien-he/page.tsx:13-44`).
- [ ] Cho phép cấu hình menu/header/footer từ settings, render theo dữ liệu Supabase thay vì hardcode.
- [ ] Tối ưu `SharedFooter` để cache kết quả `getSettings` (hiện gọi Supabase mỗi render ở `src/components/layout/SharedFooter.tsx:10-17`).

## 3. Kiến trúc Settings & nội dung động
- [ ] Viết service `settings` typed: parse JSONB đúng kiểu thay vì ép chuỗi (`src/lib/settings-actions.ts:15-34`).
- [ ] Cập nhật `SettingsForm` để chỉnh site info, menu, hero copy, CTA, Facebook comments… với validation rõ ràng.
- [ ] Thêm API để các trang (home, footer, meta tags) đọc dữ liệu typed thay vì fallback string cứng (`src/app/page.tsx:30-46`).

## 4. SEO & Metadata
- [ ] Sửa bug query `software_products` trong `src/app/sitemap.ts:33-43` (đang `.eq('is_active', true)` nhưng bảng chỉ có `status`).
- [ ] Tạo canonical URL + OpenGraph + Twitter meta builder dùng base URL từ env cho tất cả trang động.
- [ ] Thêm schema Article/SoftwareApplication và cập nhật sitemap để cover bài viết/phiên bản mới nhất.

## 5. Kiểu dữ liệu cho route params & search
- [ ] Đổi mọi `params`/`searchParams` về dạng sync (không `Promise`) như ở `src/app/[category]/page.tsx:15-16` và `src/app/tim-kiem/page.tsx:16`.
- [ ] Bổ sung loading/error states, chia nhỏ component để tránh lặp header/search form trên `/tim-kiem`.
- [ ] Đảm bảo `SearchBox` hoạt động mobile (hiện `className="hidden md:flex"`).

## 6. Hệ thống tải phần mềm & log download
- [ ] Thay direct link `file_url` trong `src/app/phan-mem/[slug]/page.tsx:183-244` bằng API/route tạo signed URL từ Supabase Storage.
- [ ] Cập nhật `src/components/DownloadButton.tsx:5-45` để gọi endpoint mới (có log IP/UA) và thông báo lỗi nếu file bị chặn.
- [ ] Viết migration/triggers đảm bảo `download_logs` lưu đầy đủ `software_id`, IP, user agent.

## 7. Cải tiến trang chủ & trang công cộng
- [ ] Home hiện chỉ hiển thị hero + featured software (`src/app/page.tsx:30-150`); bổ sung các block theo Task.md (bài mới theo chuyên mục, testimonial, CTA rõ).
- [ ] Sử dụng ISR hợp lý: `getSettings` nên cache, các query khác nên có `revalidateTag` thay vì `revalidate = 60` cố định.

## 8. Taxonomy, media & attachments
- [ ] `PostForm` chưa cho chọn tag/attachments (`src/components/admin/PostForm.tsx:83-150`), bổ sung UI + server action lưu `post_tags` và `post_attachments`.
- [ ] Kết nối Media Library vào Post/Software form để chọn ảnh đại diện/OG.

## 9. Audit logging & RBAC
- [ ] Hiện chỉ log khi tạo bài viết (`src/lib/post-actions.ts:153-154`). Mở rộng `logAuditEvent` cho update/delete post, settings, software, contact status.
- [ ] Thêm guard RBAC rõ ràng ở `src/lib/admin-contact-actions.ts` và các action khác, ghi audit khi đổi trạng thái liên hệ hoặc xóa dữ liệu.

## 10. Liên hệ & chống spam
- [ ] `submitContactForm` chưa rate-limit hay gửi thông báo (`src/lib/contact-actions.ts:19-58`). Thêm throttle theo IP/email, optional email/Zalo webhook.
- [ ] Trang admin contacts cần filter/status tabs & tìm kiếm, pagination khi số lượng lớn.

## 11. Bảo mật & scripts
- [ ] Dù đã dùng `DATABASE_URL`, các script seed vẫn in text móc accent lỗi; bổ sung file `.env.example` và hướng dẫn chạy seed an toàn.
- [ ] Đảm bảo middleware không rò SUPABASE_ANON_KEY, xem lại `middleware.ts` refresh session logic.
